package sbnz.integracija;

import sbz.cardiagnosticbe.model.drools.VisibleIndicators;
import sbz.cardiagnosticbe.model.drools.FailureList;
import sbz.cardiagnosticbe.model.Failure;
import sbz.cardiagnosticbe.model.Indicator;

import java.util.Set;
import java.util.List;

rule "Detect failures"
    agenda-group "detect-failure"
    when
        $result: FailureList();
        $vi: VisibleIndicators($visibleIndicators: indicators, $carState: carState);
        $f: Failure($failureIndicators: indicators, carState == $carState);
        checkFailureIndicators($failureIndicators, $visibleIndicators;);
    then
        $result.getFailures().add($f);
end

query checkFailureIndicators(Set failureAllIndicators, Set visibleIndicators)
    $cnt := Number(intValue == failureAllIndicators.size()) from accumulate(
        Object(this memberOf failureAllIndicators) from visibleIndicators,
        init(int count = 0;),
        action(count += 1;),
        result(count)
    )
end
